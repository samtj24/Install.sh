name: ðŸ§ª Test Installation Scripts

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐº ÐºÐ°Ð¶Ð´ÑƒÑŽ Ð½ÐµÐ´ÐµÐ»ÑŽ Ð² Ð¿Ð¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 9:00 UTC
    - cron: '0 9 * * 1'

jobs:
  shellcheck:
    name: ðŸ” ShellCheck Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸš Run ShellCheck
      uses: ludeeus/action-shellcheck@master
      with:
        scandir: '.'
        format: gcc
        severity: error
      env:
        SHELLCHECK_OPTS: -e SC2034 -e SC2086 -e SC2181

  syntax-check:
    name: ðŸ”§ Bash Syntax Check  
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: âœ… Check install_arch.sh syntax
      run: |
        if [ -f "install_arch.sh" ]; then
          bash -n install_arch.sh
          echo "âœ… install_arch.sh syntax OK"
        else
          echo "âš ï¸ install_arch.sh not found"
        fi
        
    - name: âœ… Check install_arch_uefi.sh syntax
      run: |
        if [ -f "install_arch_uefi.sh" ]; then
          bash -n install_arch_uefi.sh
          echo "âœ… install_arch_uefi.sh syntax OK"
        else
          echo "âš ï¸ install_arch_uefi.sh not found"
        fi

  config-validation:
    name: ðŸ“‹ Config Files Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸŽ¯ Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y yamllint
        
    - name: âœ… Validate Alacritty config
      run: |
        if [ -f "configs/alacritty.yml" ]; then
          yamllint configs/alacritty.yml
          echo "âœ… Alacritty config is valid YAML"
        else
          echo "âš ï¸ configs/alacritty.yml not found"
        fi
        
    - name: âœ… Check i3 config syntax
      run: |
        if [ -f "configs/i3/config" ]; then
          # Ð‘Ð°Ð·Ð¾Ð²Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ñ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÑÐµÐºÑ†Ð¸Ð¹
          if grep -q "set \$mod" configs/i3/config; then
            echo "âœ… i3 config contains mod key definition"
          else
            echo "âŒ i3 config missing mod key definition"
            exit 1
          fi
          
          if grep -q "bindsym" configs/i3/config; then
            echo "âœ… i3 config contains key bindings"
          else
            echo "âŒ i3 config missing key bindings"
            exit 1
          fi
        else
          echo "âš ï¸ configs/i3/config not found"
        fi

  documentation-check:
    name: ðŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ”— Check markdown links
      uses: gaurav-nelson/github-action-markdown-link-check@v1
      with:
        use-quiet-mode: 'yes'
        use-verbose-mode: 'yes'
        config-file: '.github/mlc_config.json'
        
    - name: ðŸ“ Validate README structure
      run: |
        if [ -f "README.md" ]; then
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð°Ð»Ð¸Ñ‡Ð¸Ðµ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ñ… Ñ€Ð°Ð·Ð´ÐµÐ»Ð¾Ð²
          if grep -q "# ðŸ§ Arch Linux Auto Installer" README.md; then
            echo "âœ… README has main title"
          else
            echo "âŒ README missing main title"
            exit 1
          fi
          
          if grep -q "## ðŸš€ Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ ÑÑ‚Ð°Ñ€Ñ‚" README.md; then
            echo "âœ… README has quick start section"
          else
            echo "âŒ README missing quick start section"
            exit 1
          fi
        else
          echo "âŒ README.md not found"
          exit 1
        fi

  security-scan:
    name: ðŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ” Run security scan
      run: |
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¿Ð¾Ñ‚ÐµÐ½Ñ†Ð¸Ð°Ð»ÑŒÐ½Ð¾ Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹
        echo "ðŸ” Checking for potentially dangerous commands..."
        
        DANGEROUS_PATTERNS=(
          "rm -rf /"
          "dd if="
          "mkfs\." 
          "wipefs"
          "parted"
        )
        
        for pattern in "${DANGEROUS_PATTERNS[@]}"; do
          if grep -r "$pattern" *.sh 2>/dev/null; then
            echo "âš ï¸ Found potentially dangerous command: $pattern"
            echo "   This is expected for installation scripts, but please review carefully"
          fi
        done
        
        # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð½Ð° Ð¶ÐµÑÑ‚ÐºÐ¾ Ð·Ð°ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð°Ñ€Ð¾Ð»Ð¸/ÐºÐ»ÑŽÑ‡Ð¸
        echo "ðŸ” Checking for hardcoded secrets..."
        if grep -r -i "password.*=" *.sh 2>/dev/null | grep -v "read -s"; then
          echo "âŒ Found potential hardcoded password"
          exit 1
        fi
        
        echo "âœ… Security scan completed"

  test-environment:
    name: ðŸ§ª Test Environment Setup
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ‹ Test script in Docker container
      run: |
        # Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð¼Ð¸Ð½Ð¸Ð¼Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ñ‚ÐµÑÑ‚ Ð² ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ðµ
        cat > test_script.sh << 'EOF'
        #!/bin/bash
        set -e
        
        echo "ðŸ§ª Testing script functionality..."
        
        # ÐœÐ¾ÐºÐ°ÐµÐ¼ Ð¾Ð¿Ð°ÑÐ½Ñ‹Ðµ ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
        function wipefs() { echo "MOCK: wipefs $@"; }
        function parted() { echo "MOCK: parted $@"; }
        function mkfs.ext4() { echo "MOCK: mkfs.ext4 $@"; }
        function mkswap() { echo "MOCK: mkswap $@"; }
        function mount() { echo "MOCK: mount $@"; }
        function pacstrap() { echo "MOCK: pacstrap $@"; }
        function arch-chroot() { echo "MOCK: arch-chroot $@"; }
        function genfstab() { echo "MOCK: genfstab"; }
        
        export -f wipefs parted mkfs.ext4 mkswap mount pacstrap arch-chroot genfstab
        
        # Ð¢ÐµÑÑ‚Ð¸Ñ€ÑƒÐµÐ¼ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸
        if [ -f "install_arch.sh" ]; then
          echo "ðŸ“‹ Testing disk size check logic..."
          
          # Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð»Ð¾Ð³Ð¸ÐºÑƒ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ñ€Ð°Ð·Ð¼ÐµÑ€Ð° Ð´Ð¸ÑÐºÐ°
          MIN_SIZE=$((8*1024*1024*1024))
          TEST_SIZE=$((10*1024*1024*1024))
          
          if [ "$TEST_SIZE" -gt "$MIN_SIZE" ]; then
            echo "âœ… Disk size check logic works"
          else
            echo "âŒ Disk size check logic failed"
            exit 1
          fi
        fi
        
        echo "âœ… Basic functionality test passed"
        EOF
        
        chmod +x test_script.sh
        bash test_script.sh

  generate-report:
    name: ðŸ“Š Generate Test Report
    runs-on: ubuntu-latest
    needs: [shellcheck, syntax-check, config-validation, documentation-check, security-scan, test-environment]
    if: always()
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ðŸ“Š Generate summary
      run: |
        echo "# ðŸ§ª Test Results Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Test | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ShellCheck | ${{ needs.shellcheck.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Syntax Check | ${{ needs.syntax-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Config Validation | ${{ needs.config-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Documentation | ${{ needs.documentation-check.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Security Scan | ${{ needs.security-scan.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Environment Test | ${{ needs.test-environment.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
